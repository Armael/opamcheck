#!/bin/bash

if [ -z "$OPAMCHECKDIR" ]; then
    echo 'error: env variable OPAMCHECKDIR is not set' >&2
    exit 2
fi

if [ -z "$OPAMCHECKVERSION" ]; then
    echo 'error: env variable OPAMCHECKVERSION is not set' >&2
    exit 2
fi

logdir="$OPAMCHECKDIR/log/opam"
opambuilddir="$OPAMCHECKDIR/opam/src"
export PATH="$opambuilddir:$OPAMCHECKDIR/install/$OPAMCHECKVERSION/bin:$PATH"
export OPAMROOT="$OPAMCHECKDIR/dot-opam/$OPAMCHECKVERSION"
export OPAMCURL=opamcheck-curl

if [ "$1" != init ]; then eval $($opambuilddir/opam config env); fi

printf "\nopamcheck-opam launched at `date`\n" >>"$logdir/$$"
printf "  command line: %s %s\n" "$0" "$*" >>"$logdir/$$"
if [ "$1" != init ]; then "$opambuilddir/opam" list >>"$logdir/$$" 2>&1; fi

"$opambuilddir/opam" "$@"

result=$?
printf "==> result code = %d\n" "$result" >>"$logdir/$$"
exit $result
