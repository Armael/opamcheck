#!/bin/bash

if [ -z "$OPAMCHECKDIR" ]; then
    echo 'error: env variable OPAMCHECKDIR is not set' >&2
    exit 2
fi

if [ -z "$OPAMCHECKVERSION" ]; then
    echo 'error: env variable OPAMCHECKVERSION is not set' >&2
    exit 2
fi

logdir="$OPAMCHECKDIR/log/opam"
opambuilddir="$OPAMCHECKDIR/opam/src"
export PATH="$opambuilddir:$OPAMCHECKDIR/install/$OPAMCHECKVERSION/bin:$PATH"
export OPAMROOT="$OPAMCHECKDIR/dot-opam/$OPAMCHECKVERSION"
export OPAMFETCH='opamcheck-fetch %{url}% %{out}% %{checksum}%'
export OPAMUTF8=never
export OPAMUTF8MSGS=0
export TERM=dumb

case $1 in
    init) ;;
    config) ;;
    *) eval $($opambuilddir/opam config env)
       export OPAMUTF8MSGS=0
       ;;
esac

printf "\nopamcheck-opam launched at `date`\n" >>"$logdir/$$"
printf "  command line: %s %s\n" "$0" "$*" >>"$logdir/$$"

case $1 in
    init) ;;
    config) ;;
    *) "$opambuilddir/opam" list >>"$logdir/$$" 2>&1;;
esac

"$opambuilddir/opam" "$@"

result=$?
printf "==> result code = %d\n" "$result" >>"$logdir/$$"
exit $result
