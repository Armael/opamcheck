#!/bin/sh

: ${OPAMCHECKVERSION:?} || exit 2

export PATH="$OPAMCHECKDIR/install/$OPAMCHECKVERSION/bin:$PATH"

rm -rf "$OPAMCHECKDIR/dot-opam/$OPAMCHECKVERSION"

checkbranch=true

usage () {
    echo "usage: opamcheck-reinit [-no-check-branch]" >&2
    exit 2
}

while [[ $# > 0 ]]; do
    case $1 in
        -no-check-branch) checkbranch=false;;
        *) usage;;
    esac
done

if $checkbranch; then
    if [ -f "$OPAMCHECKDIR/etc/branch" ]; then
        branch=$(< "$OPAMCHECKDIR/etc/branch")
    else
        branch=master
    fi
    (
        cd "$OPAMCHECKDIR/opam-repository"
        git status | grep "On branch $branch" >/dev/null 2>&1
    )
    case $? in
        0);;
        *) read -p "OPAM repo is not on branch $branch. Continue? [y/N] " \
                answer
            case $answer in
                [Yy]*);;
                *)  echo "OPAM repo is not on branch '$branch'. Stop."
                    exit 3;;
            esac;;
    esac
fi

opamcheck-opam init --no-setup -t default "$OPAMCHECKDIR/opam-repository"
opamcheck-opam repository add opamcheck-local "$OPAMCHECKDIR/switches"
opamcheck-opam switch set "$OPAMCHECKVERSION+opamcheck"
